## 第四次作业
参考Hystrix 实现一个滑动窗口计数器。

### 概要设计
客户端请求上游服务，上游服务再请求下游服务，设置下游服务一定概率返回失败或者成功。在上游服务设置一个中间件（带有滑动窗口计数功能）来统计请求数、失败率，
两者到达一定的阈值就开启熔断功能，直接由上游服务拒绝请求，请求不会到达下游服务，一定时间间隔之后又会关闭熔断。上下游服务是用gin 框架实现的

#### 滑动窗口计数实现
[如果对滑动窗口计数不太理解可以点这里](https://blog.csdn.net/legend050709/article/details/114917637)，用RollingWindow 类型来表示滑动窗口，可以设置窗口大小，每个小窗口用Bucket 类型表示，它维护独立的请求总数、错误总数。操作窗口时用到了sync.RWMutex，如增加窗口，修改熔断状态值等。RollingWindow 类型提供的方法有
* Launch() 启动滑动窗口，启动一个goroutine每隔200ms 增加一个小窗口，如果超出了窗口大小就剔除第一个窗口。窗口用一个slice 来存储
* Monitor() 监控是否开启熔断，启动一个goroutine 判断是否开启熔断，如果开启了熔断就判断是否要关闭熔断
* BreakJudgement() 根据请求总数、失败率阈值判断是否开启熔断
* ShowStatus() 为了方便调试启动一个goroutine 每1s输出熔断状态

Bucket 主要方法
* Record() 记录请求总数、失败总数，操作时用到了sync.RWMutex

### 程序结果
```
# 下载依赖包
cd sliding-window
go mod download

# 启动下游服务，设置请求成功率0.2
go run demo/down-stream/main.go

# 启动上游服务，会有一个goroutine 一直输出熔断状态
# 为了方便调试，窗口大小配置的是10，请求总数、失败率阈值分别是2，0.4，熔断恢复间隔5s
go run demo/up-stream/main.go

# 启动客户端发起请求，为了方便调试只发起了10个请求
go run demo/client/main.go
```
结果示例：
```
# 上游
2022/04/17 11:01:36 是否开启熔断 false
2022/04/17 11:01:37 是否开启熔断 false
2022/04/17 11:01:38 是否开启熔断 false
2022/04/17 11:01:39 是否开启熔断 false
2022/04/17 11:01:40 是否开启熔断 false
2022/04/17 11:01:41 是否开启熔断 false
....

# client 发起请求
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 200: 请求下游服务成功
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败
2022/04/17 11:10:11 500: 被下游服务返回失败

2022/04/17 11:10:11 是否开启熔断 true
2022/04/17 11:10:11 是否开启熔断 true

# client 再发10个请求
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝
2022/04/17 11:10:14 500: 请求被上游服务拒绝

# 5s 后client 在发起请求，熔断状态又被关闭
2022/04/17 11:11:20 是否开启熔断 false
2022/04/17 11:11:20 是否开启熔断 false
...

2022/04/17 11:11:23 500: 被下游服务返回失败
2022/04/17 11:11:23 500: 被下游服务返回失败
2022/04/17 11:11:23 500: 被下游服务返回失败
2022/04/17 11:11:23 500: 被下游服务返回失败
2022/04/17 11:11:24 500: 被下游服务返回失败
2022/04/17 11:11:24 500: 被下游服务返回失败
2022/04/17 11:11:24 500: 被下游服务返回失败
2022/04/17 11:11:24 500: 被下游服务返回失败
2022/04/17 11:11:24 200: 请求下游服务成功
2022/04/17 11:11:24 500: 被下游服务返回失败
```

### todo
* 把配置加入配置文件
* 控制启动的goroutine 生命周期

### reference
1. https://blog.csdn.net/legend050709/article/details/114917637 
2. https://github.com/AkiOuma/rolling-window-demo?ref=golangexample.com